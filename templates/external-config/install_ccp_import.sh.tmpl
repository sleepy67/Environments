#!/usr/bin/env bash
##Run as fuseadm

ccp_import_version=???
environments_version=???
CI_SERVER={{TFC.CI_SERVER}}
CONTAINERS={{TFC.CONTAINERS}}

checker()
{
wget $1
if [ $? -eq 0 ]
then
echo "-----------got that one------------"
else
echo "-----------failed------------------"
rm -f *.zip
exit $?
fi
}

mkdir /appl/builddir/$ccp_import_version
checker "--content-disposition http://$CI_SERVER/service/local/artifact/maven/redirect?g=net.atos.tfc&a=ccpimport&v=$ccp_import_version&r=public&p=zip -O /appl/builddir/$ccp_import_version/tfc-ccpimport-$ccp_import_version.zip"
checker "--content-disposition http://$CI_SERVER/service/local/artifact/maven/redirect?g=net.atos.tfc.environments.${env}&a=ccpimport-config&v=$environments_version&r=public&p=zip -O /appl/builddir/$ccp_import_version/config-properties-$environments_version.zip"


unzip -o /appl/builddir/$ccp_import_version/tfc-ccpimport-$ccp_import_version.zip -d /appl/builddir/$ccp_import_version
unzip -o /appl/builddir/$ccp_import_version/config-properties-$environments_version.zip -d /appl/builddir/$ccp_import_version

mv /appl/builddir/$ccp_import_version/ccpimport.sh /appl/builddir/$ccp_import_version/CCPIMPORT.sh
rm /appl/builddir/$ccp_import_version/*.zip

for i in "${CONTAINERS[@]}"
do
scp /appl/builddir/$ccp_import_version/*.jar @$i:/appl/tfc/portal/ccpimport
scp /appl/builddir/$ccp_import_version/*.properties @$i:/appl/tfc/portal/ccpimport
scp /appl/builddir/$ccp_import_version/*.sh @$i:/appl/tfc/portal/ccpimport/scripts
ssh $i "chmod 777 /appl/tfc/portal/ccpimport/scripts/CCPIMPORT.sh && \
chmod 777 /appl/tfc/portal/ccpimport/ccpimport-$ccp_import_version.jar && \
chmod 770 /appl/tfc/portal/ccpimport/ccpimport.properties"
done
